import pandas as pd
from bs4 import BeautifulSoup
import re
import warnings

warnings.filterwarnings('ignore')  # Suppress warnings for cleaner output

# Define key columns to extract as knowledge points (based on analysis)

key_columns = [ '(必填)名称', '别名',  '自定义页签', '生效时间', '失效时间', '知识ID', '责任采编', '(必填)知识路径', '(必填)知识类型', '授权地市', '特別說明/重要事項', '特別說明/重要事項-例外', '商品介紹', '商品介紹-例外', '頁面導覽', '頁面導覽-例外', '適用客人', '適用客人-例外', '產品簡介', '產品簡介-例外', '產品賣點', '產品賣點-例外', '宣傳渠道', '宣傳渠道-例外', '宣傳內容', '宣傳內容-例外', '銷售渠道', '銷售渠道-例外', '簡介', '簡介-例外', '一般處理', '一般處理-例外', '進階處理', '進階處理-例外', '設定類別', '設定類別-例外', '簡介.1', '簡介-例外.1', '「iPhone 檢視」', '「iPhone 檢視」-例外', '產品檢視', '產品檢視-例外', '設定類別.1', '設定類別-例外.1', '傳輸制式', '傳輸制式-例外', 'APN', 'APN-例外', '適用客人.1', '適用客人-例外.1', '簡介.2', '簡介-例外.2', '步驟及使用', '步驟及使用-例外', '類別名稱', '類別名稱-例外', '適用客人.2', '適用客人-例外.2', '詳情', '詳情-例外', '步驟及使用.1', '步驟及使用-例外.1', '類別名稱.1', '類別名稱-例外.1', '適用客人.3', '適用客人-例外.3', '詳情.1', '詳情-例外.1', '步驟及使用.2', '步驟及使用-例外.2', '設定類別.2', '設定類別-例外.2', '適用客人.4', '適用客人-例外.4', '詳情.2', '詳情-例外.2', '步驟及使用.3', '步驟及使用-例外.3', '類別名稱.2', '類別名稱-例外.2', '適用客人.5', '適用客人-例外.5', '詳情.3', '詳情-例外.3', '步驟及使用.4', '步驟及使用-例外.4', '設定類別.3', '設定類別-例外.3', '傳輸制式.1', '傳輸制式-例外.1', 'APN.1', 'APN-例外.1', '適用客人.6', '適用客人-例外.6', '簡介.3', '簡介-例外.3', '步驟及使用.5', '步驟及使用-例外.5', '設定類別.4', '設定類別-例外.4', '傳輸制式.2', '傳輸制式-例外.2', 'APN.2', 'APN-例外.2', '適用客人.7', '適用客人-例外.7', '簡介.4', '簡介-例外.4', '步驟及使用.6', '步驟及使用-例外.6', '設定類別.5', '設定類別-例外.5', '傳輸制式.3', '傳輸制式-例外.3', 'APN.3', 'APN-例外.3', '適用客人.8', '適用客人-例外.8', '簡介.5', '簡介-例外.5', '步驟及使用.7', '步驟及使用-例外.7', '設定類別.6', '設定類別-例外.6', '傳輸制式.4', '傳輸制式-例外.4', 'APN.4', 'APN-例外.4', '適用客人.9', '適用客人-例外.9', '簡介.6', '簡介-例外.6', '步驟及使用.8', '步驟及使用-例外.8', '排障流程', '排障流程-例外', '收費', '收費-例外', '收費模式', '收費模式-例外', '條款細則', '條款細則-例外', '疑難排解/排障 1', '疑難排解/排障 1-例外', '疑難排解/排障 2', '疑難排解/排障 2-例外', 'FAQ 分類一', 'FAQ 分類一-例外', 'FAQ 分類二', 'FAQ 分類二-例外', 'FAQ 分類三', 'FAQ 分類三-例外', 'FAQ 分類四', 'FAQ 分類四-例外', 'FAQ 分類五', 'FAQ 分類五-例外', '系統顯示', '系統顯示-例外', 'BOSS產品名稱', 'BOSS產品名稱-例外', 'BOSS代碼', 'BOSS代碼-例外', '投訴處理指引', '投訴處理指引-例外', '優先級', '優先級-例外', '項目責任部門', '項目責任部門-例外', '更新事宜', '更新事宜-例外', '知識通知形式', '知識通知形式-例外', '更新人員', '更新人員-例外', '辦理附件', '辦理附件-例外', '搜索關鍵詞', '搜索關鍵詞-例外', '以往紀錄', '以往紀錄-例外', 'source_file', '推出日期', '推出日期-例外', '結束日期', '結束日期-例外', '服務介紹', '服務介紹-例外', '背景/目的', '背景/目的-例外', '賣點', '賣點-例外', '產品重量', '產品重量-例外', 'APN 名稱', 'APN 名稱-例外', '注意事項', '注意事項-例外', '聯絡資訊名稱', '聯絡資訊名稱-例外', '其他適用客人', '其他適用客人-例外', '啟用日期', '啟用日期-例外', '地址', '地址-例外', '查詢電話', '查詢電話-例外', '聯絡資訊名稱.1', '聯絡資訊名稱-例外.1', '其他適用客人.1', '其他適用客人-例外.1', '啟用日期.1', '啟用日期-例外.1', '地址.1', '地址-例外.1', '查詢電話.1', '查詢電話-例外.1', '聯絡資訊名稱.2', '聯絡資訊名稱-例外.2', '其他適用客人.2', '其他適用客人-例外.2', '啟用日期.2', '啟用日期-例外.2', '地址.2', '地址-例外.2', '查詢電話.2', '查詢電話-例外.2', '宣傳對象', '宣傳對象-例外', '宣傳詳情', '宣傳詳情-例外', '宣傳目的', '宣傳目的-例外', '其他資訊', '其他資訊-例外', 'SMS總匯–業務渠道', 'SMS總匯–業務渠道-例外', '合約介紹', '合約介紹-例外', '頁面/服務名稱', '頁面/服務名稱-例外', '網站連結', '網站連結-例外', '服務簡介', '服務簡介-例外', '服務詳情', '服務詳情-例外', '優惠内容', '優惠内容-例外', '聯絡資訊', '聯絡資訊-例外', '辦公時間', '辦公時間-例外', '支援系統', '支援系統-例外', '申請渠道', '申請渠道-例外', '申請界面', '申請界面-例外', '入口位置', '入口位置-例外', '查詢路徑', '查詢路徑-例外', '内部查詢路徑', '内部查詢路徑-例外', '受理路徑', '受理路徑-例外', 'VAS受理路徑', 'VAS受理路徑-例外', 'OFFER受理路徑', 'OFFER受理路徑-例外', '變更渠道', '變更渠道-例外', '變更流程', '變更流程-例外', '取消路徑', '取消路徑-例外', '取消渠道', '取消渠道-例外', '取消流程', '取消流程-例外', '其他宣傳渠道', '其他宣傳渠道-例外', '宣傳内容', '宣傳内容-例外', '功能界面（一）', '功能界面（一）-例外', '功能界面（二）', '功能界面（二）-例外', '功能界面（三）', '功能界面（三）-例外', '功能界面（四）', '功能界面（四）-例外', '功能界面（五）', '功能界面（五）-例外', '名稱', '名稱-例外', '登入', '登入-例外', '支援系統.1', '支援系統-例外.1', '流程', '流程-例外', '注意事項.1', '注意事項-例外.1', '名稱.1', '名稱-例外.1', '登入.1', '登入-例外.1', '支援系統.2', '支援系統-例外.2', '流程.1', '流程-例外.1', '注意事項.2', '注意事項-例外.2', '名稱.2', '名稱-例外.2', '登入.2', '登入-例外.2', '支援系統.3', '支援系統-例外.3', '流程.2', '流程-例外.2', '注意事項.3', '注意事項-例外.3', '名稱.3', '名稱-例外.3', '登入.3', '登入-例外.3', '支援系統.4', '支援系統-例外.4', '流程.3', '流程-例外.3', '注意事項.4', '注意事項-例外.4', '名稱.4', '名稱-例外.4', '登入.4', '登入-例外.4', '支援系統.5', '支援系統-例外.5', '詳情.4', '詳情-例外.4', '流程.4', '流程-例外.4', '注意事項.5', '注意事項-例外.5', '名稱.5', '名稱-例外.5', '登入.5', '登入-例外.5', '支援系統.6', '支援系統-例外.6', '詳情.5', '詳情-例外.5', '流程.5', '流程-例外.5', '注意事項.6', '注意事項-例外.6', '名稱.6', '名稱-例外.6', '登入.6', '登入-例外.6', '支援系統.7', '支援系統-例外.7', '詳情.6', '詳情-例外.6', '流程.6', '流程-例外.6', '注意事項.7', '注意事項-例外.7', '名稱.7', '名稱-例外.7', '簡介.7', '簡介-例外.7', '登入.7', '登入-例外.7', '支援系統.8', '支援系統-例外.8', '詳情.7', '詳情-例外.7', '流程.7', '流程-例外.7', '注意事項.8', '注意事項-例外.8', '名稱.8', '名稱-例外.8', '簡介.8', '簡介-例外.8', '登入.8', '登入-例外.8', '支援系統.9', '支援系統-例外.9', '詳情.8', '詳情-例外.8', '流程.8', '流程-例外.8', '注意事項.9', '注意事項-例外.9', '名稱.9', '名稱-例外.9', '簡介.9', '簡介-例外.9', '適用客人.10', '適用客人-例外.10', '登入.9', '登入-例外.9', '支援系統.10', '支援系統-例外.10', '詳情.9', '詳情-例外.9', '流程.9', '流程-例外.9', '注意事項.10', '注意事項-例外.10', '名稱.10', '名稱-例外.10', '簡介.10', '簡介-例外.10', '適用客人.11', '適用客人-例外.11', '登入.10', '登入-例外.10', '支援系統.11', '支援系統-例外.11', '詳情.10', '詳情-例外.10', '流程.10', '流程-例外.10', '注意事項.11', '注意事項-例外.11', '名稱.11', '名稱-例外.11', '簡介.11', '簡介-例外.11', '適用客人.12', '適用客人-例外.12', '登入.11', '登入-例外.11', '支援系統.12', '支援系統-例外.12', '詳情.11', '詳情-例外.11', '流程.11', '流程-例外.11', '注意事項.12', '注意事項-例外.12', '名稱.12', '名稱-例外.12', '簡介.12', '簡介-例外.12', '適用客人.13', '適用客人-例外.13', '登入.12', '登入-例外.12', '支援系統.13', '支援系統-例外.13', '詳情.12', '詳情-例外.12', '流程.12', '流程-例外.12', '注意事項.13', '注意事項-例外.13', '名稱.13', '名稱-例外.13', '簡介.13', '簡介-例外.13', '適用客人.14', '適用客人-例外.14', '登入.13', '登入-例外.13', '支援系統.14', '支援系統-例外.14', '詳情.13', '詳情-例外.13', '流程.13', '流程-例外.13', '注意事項.14', '注意事項-例外.14', '名稱.14', '名稱-例外.14', '簡介.14', '簡介-例外.14', '適用客人.15', '適用客人-例外.15', '登入.14', '登入-例外.14', '支援系統.15', '支援系統-例外.15', '詳情.14', '詳情-例外.14', '流程.14', '流程-例外.14', '注意事項.15', '注意事項-例外.15', '名稱.15', '名稱-例外.15', '簡介.15', '簡介-例外.15', '適用客人.16', '適用客人-例外.16', '登入.15', '登入-例外.15', '支援系統.16', '支援系統-例外.16', '詳情.15', '詳情-例外.15', '流程.15', '流程-例外.15', '注意事項.16', '注意事項-例外.16', '名稱.16', '名稱-例外.16', '簡介.16', '簡介-例外.16', '適用客人.17', '適用客人-例外.17', '登入.16', '登入-例外.16', '支援系統.17', '支援系統-例外.17', '詳情.16', '詳情-例外.16', '流程.16', '流程-例外.16', '注意事項.17', '注意事項-例外.17', '名稱.17', '名稱-例外.17', '簡介.17', '簡介-例外.17', '適用客人.18', '適用客人-例外.18', '登入.17', '登入-例外.17', '支援系統.18', '支援系統-例外.18', '詳情.17', '詳情-例外.17', '流程.17', '流程-例外.17', '注意事項.18', '注意事項-例外.18', '名稱.18', '名稱-例外.18', '簡介.18', '簡介-例外.18', '適用客人.19', '適用客人-例外.19', '登入.18', '登入-例外.18', '支援系統.19', '支援系統-例外.19', '詳情.18', '詳情-例外.18', '流程.18', '流程-例外.18', '注意事項.19', '注意事項-例外.19', '名稱.19', '名稱-例外.19', '簡介.19', '簡介-例外.19', '適用客人.20', '適用客人-例外.20', '登入.19', '登入-例外.19', '支援系統.20', '支援系統-例外.20', '詳情.19', '詳情-例外.19', '流程.19', '流程-例外.19', '注意事項.20', '注意事項-例外.20', '滿意度調研問卷', '滿意度調研問卷-例外', '提示主旨', '提示主旨-例外', '發送日期', '發送日期-例外', '通知提示發送渠道', '通知提示發送渠道-例外', '短訊/電郵提示接收者', '短訊/電郵提示接收者-例外', '短訊提示内容（繁）', '短訊提示内容（繁）-例外', '短訊提示内容（簡）', '短訊提示内容（簡）-例外', '短訊提示内容（英）', '短訊提示内容（英）-例外', '電郵提示内容（繁）', '電郵提示内容（繁）-例外', '電郵提示内容（簡）', '電郵提示内容（簡）-例外', '電郵提示内容（英）', '電郵提示内容（英）-例外', 'APP PUSH推送内容（繁）', 'APP PUSH推送内容（繁）-例外', 'APP PUSH推送内容（簡）', 'APP PUSH推送内容（簡）-例外', 'APP PUSH推送内容（英）', 'APP PUSH推送内容（英）-例外', 'MyLink提示内容（繁）', 'MyLink提示内容（繁）-例外', 'MyLink提示内容（簡）', 'MyLink提示内容（簡）-例外', 'MyLink提示内容（英）', 'MyLink提示内容（英）-例外', '通知提示内容', '通知提示内容-例外', '提示主旨.1', '提示主旨-例外.1', '發送日期.1', '發送日期-例外.1', '通知提示發送渠道.1', '通知提示發送渠道-例外.1', '短訊/電郵提示接收者.1', '短訊/電郵提示接收者-例外.1', '短訊提示内容（繁）.1', '短訊提示内容（繁）-例外.1', '短訊提示内容（簡）.1', '短訊提示内容（簡）-例外.1', '短訊提示内容（英）.1', '短訊提示内容（英）-例外.1', '電郵提示内容（繁）.1', '電郵提示内容（繁）-例外.1', '電郵提示内容（簡）.1', '電郵提示内容（簡）-例外.1', '電郵提示内容（英）.1', '電郵提示内容（英）-例外.1', 'APP PUSH推送内容（繁）.1', 'APP PUSH推送内容（繁）-例外.1', 'APP PUSH推送内容（簡）.1', 'APP PUSH推送内容（簡）-例外.1', 'APP PUSH推送内容（英）.1', 'APP PUSH推送内容（英）-例外.1', 'MyLink提示内容（繁）.1', 'MyLink提示内容（繁）-例外.1', 'MyLink提示内容（簡）.1', 'MyLink提示内容（簡）-例外.1', 'MyLink提示内容（英）.1', 'MyLink提示内容（英）-例外.1', '通知提示内容.1', '通知提示内容-例外.1', '提示主旨.2', '提示主旨-例外.2', '發送日期.2', '發送日期-例外.2', '通知提示發送渠道.2', '通知提示發送渠道-例外.2', '短訊/電郵提示接收者.2', '短訊/電郵提示接收者-例外.2', '短訊提示内容（繁）.2', '短訊提示内容（繁）-例外.2', '短訊提示内容（簡）.2', '短訊提示内容（簡）-例外.2', '短訊提示内容（英）.2', '短訊提示内容（英）-例外.2', '電郵提示内容（繁）.2', '電郵提示内容（繁）-例外.2', '電郵提示内容（簡）.2', '電郵提示内容（簡）-例外.2', '電郵提示内容（英）.2', '電郵提示内容（英）-例外.2', 'APP PUSH推送内容（繁）.2', 'APP PUSH推送内容（繁）-例外.2', 'APP PUSH推送内容（簡）.2', 'APP PUSH推送内容（簡）-例外.2', 'APP PUSH推送内容（英）.2', 'APP PUSH推送内容（英）-例外.2', 'MyLink提示内容（繁）.2', 'MyLink提示内容（繁）-例外.2', 'MyLink提示内容（簡）.2', 'MyLink提示内容（簡）-例外.2', 'MyLink提示内容（英）.2', 'MyLink提示内容（英）-例外.2', '通知提示内容.2', '通知提示内容-例外.2', '提示主旨.3', '提示主旨-例外.3', '發送日期.3', '發送日期-例外.3', '通知提示發送渠道.3', '通知提示發送渠道-例外.3', '短訊/電郵提示接收者.3', '短訊/電郵提示接收者-例外.3', '短訊提示内容（繁）.3', '短訊提示内容（繁）-例外.3', '短訊提示内容（簡）.3', '短訊提示内容（簡）-例外.3', '短訊提示内容（英）.3', '短訊提示内容（英）-例外.3', '電郵提示内容（繁）.3', '電郵提示内容（繁）-例外.3', '電郵提示内容（簡）.3', '電郵提示内容（簡）-例外.3', '電郵提示内容（英）.3', '電郵提示内容（英）-例外.3', 'APP PUSH推送内容（繁）.3', 'APP PUSH推送内容（繁）-例外.3', 'APP PUSH推送内容（簡）.3', 'APP PUSH推送内容（簡）-例外.3', 'APP PUSH推送内容（英）.3', 'APP PUSH推送内容（英）-例外.3', 'MyLink提示内容（繁）.3', 'MyLink提示内容（繁）-例外.3', 'MyLink提示内容（簡）.3', 'MyLink提示内容（簡）-例外.3', 'MyLink提示内容（英）.3', 'MyLink提示内容（英）-例外.3', '通知提示内容.3', '通知提示内容-例外.3', '服務或產品', '知识点' ]
# Function to clean HTML tags from text
def clean_html(text):
    if pd.isna(text):
        return text
    soup = BeautifulSoup(str(text), 'html.parser')
    cleaned = soup.get_text(separator=' ', strip=True)
    # Remove extra spaces and newlines
    cleaned = re.sub(r'\s+', ' ', cleaned).strip()
    return cleaned if cleaned else None

# Read CSV file
try:
    df = pd.read_csv('手机及配件整理.csv', encoding='utf-8')
except FileNotFoundError:
    print("Error: '手机及配件整理.csv' not found.")
    exit(1)
except UnicodeDecodeError:
    print("Error: File encoding issue. Please ensure the file is UTF-8 encoded.")
    exit(1)

# Filter key columns (only those that exist in the CSV)
available_columns = [col for col in key_columns if col in df.columns]
df_filtered = df[available_columns]

# Clean HTML content in all columns
for col in df_filtered.columns:
    df_filtered[col] = df_filtered[col].apply(clean_html)

# Merge related columns (e.g., combine '通知提示內容' variants)
def merge_columns(df, base_name, variants):
    if base_name in df.columns:
        merged = df[base_name].copy()
        for variant in variants:
            if variant in df.columns:
                merged = merged.combine_first(df[variant])
        return merged
    return None

# Example: Merge notification content columns
notification_cols = [col for col in df.columns if col.startswith('通知提示內容') and col not in key_columns]
if notification_cols:
    df_filtered['通知提示內容_合併'] = merge_columns(df, '通知提示內容(繁中)', notification_cols)
# Similarly merge other repetitive columns (e.g., '收費', '注意事項')
charge_cols = [col for col in df.columns if col.startswith('收費.') and col not in key_columns]
if charge_cols:
    df_filtered['收費_合併'] = merge_columns(df, '收費', charge_cols)

note_cols = [col for col in df.columns if col.startswith('注意事項.') and col not in key_columns]
if note_cols:
    df_filtered['注意事項_合併'] = merge_columns(df, '注意事項', note_cols)

# Remove fully empty columns
df_filtered = df_filtered.dropna(axis=1, how='all')

# Save to Excel
output_file = 'knowledge_points-手机及配件.xlsx'
df_filtered.to_excel(output_file, index=False, engine='openpyxl')
print(f"Excel file '{output_file}' generated successfully.")



# Note: Further merging logic can be added as needed for other repetitive fields
